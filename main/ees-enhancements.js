!function d(s,r,l){function o(t,e){if(!r[t]){if(!s[t]){var a="function"==typeof require&&require;if(!e&&a)return a(t,!0);if(c)return c(t,!0);var i=new Error("Cannot find module '"+t+"'");throw i.code="MODULE_NOT_FOUND",i}var n=r[t]={exports:{}};s[t][0].call(n.exports,function(e){return o(s[t][1][e]||e)},n,n.exports,d,s,r,l)}return r[t].exports}for(var c="function"==typeof require&&require,e=0;e<l.length;e++)o(l[e]);return o}({1:[function(n,e,t){!function(){"use strict";var a,e=n(2),t=n(3),i=n(4);(a=window).EasyEditCity={debug:function(t){if(a.EasyEditConfig.debug)try{a.console.log(t)}catch(e){try{opera.postError.apply(opera,t)}catch(e){}}},getCurrentScreenName:function(){var e=a.EasyEditScreens.currentScreen;return/^([^A-Z]+)[A-Z]/.exec(e)[1]}},e.installPlugin(a),t.installPlugin(a),i.installPlugin(a)}()},{2:2,3:3,4:4}],2:[function(e,t,a){t.exports=function(){"use strict";return{installPlugin:function(t){t.EasyEdit.plugins.hidemd={init:function(){t.EasyEditEventManager.bind("EasyEditScreenLoad",this.runMdhide)},runMdhide:function(){var e;"metadata"===t.EasyEditCity.getCurrentScreenName()?(e=$('h3:contains("Widgets")')).add(e.nextUntil("h3").filter(":not(.ViperTP-bar)")).remove():t.EasyEditCity.debug("This isn't the metadata tab, hidemd bailing")}}}}}()},{}],3:[function(e,t,a){t.exports=function(){"use strict";return{installPlugin:function(c){c.EasyEdit.plugins.metadataAssetFinder={pluginConfig:{allowedAssetTypes:"news_item, page_standard, image, pdf_file, calendar_event_single, folder",assetTypeErrorMsg:"This asset type is not allowed",alreadyChosenErrorMsg:"You have already selected that asset, please choose a different one"},init:function(){$.extend(this.pluginConfig,c.EasyEditConfig.pluginConfig.relatedAssets),c.EasyEditEventManager.bind("EasyEditScreenLoad",this.metadataAssetFinder)},metadataAssetFinder:function(){var l=c.EasyEdit.plugins.metadataAssetFinder;c.EasyEditAssetManager.getCurrentAsset(function(e){for(var t,a,i,n,d=l.pluginConfig.metadataFields.length,s=0,r=!1;s<d;s++)n=l.pluginConfig.metadataFields[s],0!==(t=$("#metadata_field_text_"+n.id+"_value")).length&&(r=!0,(a=$("#metadata_field_text_"+n.id+"_default")).removeAttr("checked"),a.val(""),n.showField||t.hide(),t.removeAttr("disabled"),a.closest(".sq-metadata-settings-wrapper").hide(),0===$("#asset_finder_meta_"+n.id).length&&t.before('<span id="asset_finder_meta_'+n.id+'" class="asset_finder_meta fieldNonEditable" title="Find Image"><span></span></span>'),t.siblings('div[id^="current_related_content_"]').length?c.EasyEditCity.debug("we have already initialised "+n.id):(t.after('<div class="related-content-picker" id="current_related_content_'+n.id+'"></div>'),i=$("#current_related_content_"+n.id),n.$fieldVal=t,n.$fieldRelated=i,n.relatedAssets=[],t.val()?i.html(""):(c.EasyEditCity.debug("no related content text to be updated"),i.html("No related content"))));r&&(l.buildRelatedAssetsList(),$(".asset_finder_meta").click(function(){var e=$(this).attr("id").replace("asset_finder_meta_",""),t=l.getFieldObject(e),a=t.$fieldVal;return c.EasyEditAssetFinder.init({rootNode:t.rootNode,focusAssetId:t.focusNode||null,bindElem:"#ees_assetFinderBody",includeDependants:!0,callback:function(e){if(-1!==l.pluginConfig.allowedAssetTypes.indexOf(e.attr.type_code)){if(c.EasyEditOverlay.showOverlay("success",{timeout:1e3,message:"Metadata field updated"}),""===a.val())a.val(e.id);else{if(c.EasyEditCity.debug(t.relatedAssets),-1!==$.inArray(e.id,t.relatedAssets))return void c.EasyEditOverlay.showOverlay("error",{timeout:2e3,message:l.pluginConfig.alreadyChosenErrorMsg});a.val(a.val()+","+e.id)}a.change(),"No related content"===t.$fieldRelated.text()&&t.$fieldRelated.text(""),t.$fieldRelated.append(l.insertRelatedDiv(e)),t.relatedAssets.push(e.id),1===t.relatedAssets.length&&l.makeListsSortable(t)}else c.EasyEditOverlay.showOverlay("error",{timeout:2e3,message:l.pluginConfig.assetTypeErrorMsg})}}),!1}))})},makeListsSortable:function(e){var a=c.EasyEdit.plugins.metadataAssetFinder;$(e.$fieldRelated).sortable({stop:function(){var t=a.getFieldObject(this.id.replace(/[^0-9]/g,""));t.$fieldVal.val(""),t.relatedAssets=[],t.$fieldRelated.children().each(function(e,a){t.relatedAssets.push(a.id),t.$fieldVal.val(function(e,t){return t+a.id+","})}),t.$fieldVal.val(function(e,t){return t.replace(/,$/,"")}),t.$fieldVal.change()},disabled:!1,axis:"y",forcePlaceholderSize:!1,opacity:.5,tolerance:"pointer",containment:"parent"})},buildRelatedAssetsList:function(){var e,t,r=c.EasyEdit.plugins.metadataAssetFinder,a=r.pluginConfig.metadataFields.length,i=0,n=[],l=new c.EasyEditAPI,o=null;for(c.EasyEditAssetManager.getCurrentAsset(function(e){o=e.id});i<a;i++)e=r.pluginConfig.metadataFields[i],c.EasyEditCity.debug("building list o' divs for "+e.id),e.$fieldVal&&0!==e.$fieldVal.length?(t=e.$fieldVal.val(),c.EasyEditCity.debug("val for "+e.id+" is "+t),""!==t?(n.push(e),-1===t.indexOf(",")?e.relatedAssets=[t]:e.relatedAssets=t.split(","),c.EasyEditCity.debug("related assets is calculated as: "+e.relatedAssets)):c.EasyEditCity.debug("no related assets")):c.EasyEditCity.debug(e.id+" was not found on the page, not setting up the list");c.EasyEditCity.debug(n),0!==n.length&&function n(d){for(var s=d.shift(),e=s.relatedAssets.length,t=0;t<e;t++)l.queue("getGeneral",{asset_id:s.relatedAssets[t],get_attributes:0});l.run(function(e){var t,a=e.length,i=0;for(c.EasyEditCity.debug("api run came back for "+s.id+"("+s.relatedAssets.length+" related assets: "+s.relatedAssets+")"),c.EasyEditCity.debug(e);i<a;i++)t=e[i],0===s.$fieldRelated.find("#"+t.data.id).length&&o!=t.data.id&&(t.data.name||t.data.attr?(c.EasyEditCity.debug("appending div to "+s.$fieldRelated[0].id),s.$fieldRelated.append(r.insertRelatedDiv(t.data))):(c.EasyEditCity.debug("Unexpected data in Callback"),t.data.error?c.EasyEditCity.debug(t.data.error):c.EasyEditCity.debug(t.data)));r.makeListsSortable(s),d.length&&n(d)},l.runMode.SYNC)}(n)},insertRelatedDiv:function(e){var t,d=this,a=$("<div>",{id:e.id,class:"related_content"});return t=e.name||e.attr.name,$("<span>",{text:t+" (id: "+e.id+")"}).appendTo(a),$("<span>",{class:"delete_related_content",click:function(){var e,t,a=$(this).parent(),i=a.attr("id"),n=a.parent();e=n.attr("id").replace("current_related_content_",""),c.EasyEditCity.debug("deleting from field "+e),(t=d.getFieldObject(e)).$fieldVal.val(function(e,t){return t.replace(i,"").replace(",,",",").replace(/^,|,$/g,"")}),delete t.relatedAssets[i],a.fadeOut("slow",function(){a.remove()}),t.$fieldVal.change(),""===t.$fieldVal.attr("value")&&n.text("No related content")}}).appendTo(a),a},getFieldObject:function(e){for(var t=c.EasyEdit.plugins.metadataAssetFinder.pluginConfig.metadataFields,a=t.length,i=0;i<a;i++)if(t[i].id===parseInt(e,10))return t[i];return null}}}}}()},{}],4:[function(e,t,a){t.exports=function(){"use strict";return{installPlugin:function(r){var n;n={objectName:"widgetsDefault",className:"widgets",displayName:"Widgets",lockType:"metadata",isDefault:!1},$.each(["defaultAsset","page_standard","news_item","calendar_event_single","folder, data_record"],function(e,t){var a=r.EasyEditScreens.assetTypes[t].getConfig();r.EasyEditScreens.assetTypes[t].getConfig=function(e){var t={},a=!1;for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i],"Content"==i&&(t.Widgets=n,a=!0));return a||(t.Widgets=n),function(){return t}}(a)}),r.EasyEditScreens.screen.widgetsDefault={cache:{asset:void 0},widgets:{20981:{name:"the empty widget"},19271:{name:"News widget",md_section:19505},19541:{name:"Events widget",md_section:19503},19341:{name:"Courses widget",md_section:19502},15313:{name:"Testimonials widget",md_section:19819},24497:{name:"Contact widget",md_section:18921},15347:{name:"Map widget",md_section:19739},15351:{name:"Free text widget",md_section:18952},18958:{name:"Free text widget B",md_section:18954},903:{name:"Flickr widget",md_section:12241},118385:{name:"Twitter widget",md_section:177524},101598:{name:"RSS widget",md_section:101626},177419:{name:"Profiles widget",md_section:177570},181764:{name:"Free HTML widget",md_section:181750},187627:{name:"Spotlight on Research widget",md_section:187795},274413:{name:"Navigation",md_section:274837},121480:{name:"Social",md_section:121258},332982:{name:"Open Days",md_section:333018}},plugin_config:{allowed_asset_types:"news_item, page_standard, image, pdf_file, folder, data_record",asset_type_error_msg:"This asset type is not allowed",widgets_onpage_md_field:20462,widgets_onpage_md_field_name:"widgets.onPage"},containerId:null,init:function(e,t,i){var n=this;-1!==document.location.hostname.indexOf("cass.city.ac.uk")&&(n.widgets[107766]={name:"Call to action",md_section:107852}),n.containerId=e,r.EasyEditAssetManager.getCurrentAsset(function(e){e.acquireLock("all",function(e){"object"==typeof e[0]&&e[0].warning&&e[0].message.match(/^Unable to acquire "\w+" lock/)?i.call(n):n._getTemplate(function(e,t){var a=$(n.containerId);a.empty(),a.append(e),t&&(r.EasyEditScreens.screen.metadataDefault._attachEvents.call(n),n._attachWidgetEvents(),n._renderWidgets()),i.call(n)})})})},attachWysiwygEvents:function(){},_getTemplate:function(t){var a=this,i="";$("body").addClass("widgets"),r.EasyEditAssetManager.clearCurrentAssetCache(),r.EasyEditAssetManager._currentAssetId=null,r.EasyEditAssetManager.getCurrentAsset(function(e){(a.cache.asset=e).getMetadata(function(e){e[a.plugin_config.widgets_onpage_md_field_name]?(i='<div id="ees_editMetadata"><h4 class="sectionHeading">Widgets</h4><a id="add-widget" class="greyButton loading" href="#"><span></span><span></span></a><div id="widgets" style="display: none;"><h4>Available Widgets<a href="#" class="closeAvailableWidgets">X</a></h4><ul id="available-widgets"><li class="no-more-widgets">No More Widgets to add</li></ul></div><div id="ees_editWidgets"></div><input type="hidden" id="widgets-on-page" name="metadata_field_text_20462_value" value=""/></div>',t.call(this,i,!0)):(i='<div id="ees_editMetadata"><h3>No schema Applied</h3><p>This asset does not have the widget metadata schema applied.Your administrator will need to apply the widget schema before youwill be able to enter any metadata values.</p></div>',t.call(this,i,!1))})})},_attachWidgetEvents:function(){$("#add-widget").click(function(e){e.preventDefault(),$("#widgets").slideToggle()}),$("#ees_editWidgets").sortable({stop:this._changeWidgetOrder,axis:"y",forcePlaceholderSize:!0,containment:"parent",opacity:.5,tolerance:"pointer",handle:".widget-reorder-handle"})},_changeWidgetOrder:function(e,t){var i=[],a=$(e.target).children("div");a.length?a.each(function(e,t){var a=t.id.replace(/^[^0-9]+/,"");i.push(a)}):i.push("20981"),$("#widgets-on-page").val(i.join(",")),r.EasyEditComponentsToolbar.enableSaveButton()},_renderWidgets:function(){var a=this,t=a.cache.asset;$("body").append('<div id="widgets_metadata_container" style="display:none"></div>'),this._widgetsMetadataContainer=$("#widgets_metadata_container"),r.EasyEditScreens.screen.metadataDefault.init("#widgets_metadata_container",null,function(){$("#ees_screenContent").append($('input[type="hidden"][name^="metadata_field_related_asset_"]').detach()),$("#add-widget").removeClass("loading").find("span:first-child").text("Add Widget"),$.each(a.widgets,function(e,t){delete t.chosen});var e=t.metadataValues[a.plugin_config.widgets_onpage_md_field_name];""===e||"20981"===e?$("#widgets-on-page").val("20981"):($("#widgets-on-page").val(e),$.each(e.split(","),function(e,t){a._addWidget(t)})),a._updateWidgetPicker(),a._widgetsMetadataContainer.detach(),r.EasyEditScreens.screen.metadataDefault.containerId="#main_form"})},_addWidget:function(e){var t,i=this,a=i.widgets[e];i.cache.asset;a&&(a.chosen=!0,t=$("<div></div>",{id:a.name.replace(/\s/g,"-").toLowerCase()+"-"+e}),$("<span></span>",{class:"widget-reorder-handle"}).appendTo(t),$("<span></span>",{class:"widget-name",text:a.name}).appendTo(t),$("<span></span>",{class:"remove-widget "+e,click:function(e){var t=$(this),a=t.attr("class");e.preventDefault(),i.widgets[a.substr(a.indexOf(" ")+1)].chosen=!1,t.parent().slideUp(function(){var e=$(this);i._widgetsMetadataContainer.append(e.find(".settings .editSection").detach()),e.remove(),i._changeWidgetOrder({target:$("#ees_editWidgets")}),i._updateWidgetPicker()})}}).appendTo(t),$("<span></span>",{class:"edit-widget",text:"Settings",click:function(){$(this).next().toggle()}}).appendTo(t),t.appendTo("#ees_editWidgets"),i._appendWidgetSettings(e))},_updateWidgetPicker:function(){var a=this,i=$("#available-widgets");i.children().remove(),$.each(a.widgets,function(e,t){"20981"===e||t.chosen||$("<li></li>",{class:e}).append($("<a></a>",{text:t.name,click:a._addWidgetFromPicker,href:"#"}).append($("<span></span>",{text:"+"}))).appendTo(i)}),0===i.children().length&&i.append("<li>No more widgets to add</li>")},_addWidgetFromPicker:function(e){var t=r.EasyEditScreens.screen.widgetsDefault,a=$(this),i=a.parent().attr("class");a.parent().remove(),e.preventDefault(),t._addWidget(i),t._changeWidgetOrder({target:$("#ees_editWidgets")}),t._updateWidgetPicker()},_appendWidgetSettings:function(e){var t,a=this.widgets[e],i="#"+a.name.replace(/\s/g,"-").toLowerCase()+"-"+e,n=$("<div></div>",{class:"settings"}),d=!1;if(!a.md_section)return r.EasyEditCity.debug("no widget.md_section, appending widget.extra_info instead"),void n.append("<p><strong>"+a.extra_info+"</strong></p>");r.EasyEditCity.debug("appending settings for "+e);var s=this._widgetsMetadataContainer.find("#metadata_field_text_"+a.md_section+"_value").closest(".editSection");$(i).append(n),n.append(s.detach()),"18891"===e&&n.append(this._widgetsMetadataContainer.find("#metadata_field_text_18833_value").closest(".editSection").detach()),$(i).find('input[id$="default"]').each(function(e,t){var a=$(this);a.is(":checked")&&a[0].click(),a.next().hide(),a.hide()}).end().find("input").bind("keyup blur change",function(e){$(e.target).addClass("changed"),r.EasyEditComponentsToolbar.enableSaveButton()}),"2807"===e&&r.EasyEditScreens.screen.metadataDefault._attachEvents.call(this),"Profiles widget"!==a.name&&"Contact widget"!==a.name&&"Testimonials widget"!==a.name&&"Spotlight on Research widget"!==a.name||(d=!0,(t=$(".row_2 input.inputText",n)).attr("checked")||$(".row_3",n).addClass("picker-off"),t.click(function(e){var t=$(".row_3",n);t.hasClass("picker-off")?t.removeClass("picker-off"):t.addClass("picker-off")})),d&&r.EasyEdit.plugins.metadataAssetFinder.metadataAssetFinder(),"Call to action"===a.name&&n.find('input[name^="metadata_field_date"]').parent().addClass("dateTime")},save:function(e){r.EasyEditScreens.screen.metadataDefault.save(e)}}}}}()},{}]},{},[1]);