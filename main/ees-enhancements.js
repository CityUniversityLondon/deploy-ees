!function e(t,a,i){function n(s,r){if(!a[s]){if(!t[s]){var l="function"==typeof require&&require;if(!r&&l)return l(s,!0);if(d)return d(s,!0);var o=new Error("Cannot find module '"+s+"'");throw o.code="MODULE_NOT_FOUND",o}var c=a[s]={exports:{}};t[s][0].call(c.exports,function(e){var a=t[s][1][e];return n(a?a:e)},c,c.exports,e,t,a,i)}return a[s].exports}for(var d="function"==typeof require&&require,s=0;s<i.length;s++)n(i[s]);return n}({1:[function(e,t,a){!function(){"use strict";var t=e(2),a=e(3),i=e(4),n=function(e){e.EasyEditCity={debug:function(t){if(e.EasyEditConfig.debug)try{e.console.log(t)}catch(a){try{opera.postError.apply(opera,t)}catch(a){}}},getCurrentScreenName:function(){var t=e.EasyEditScreens.currentScreen;return/^([^A-Z]+)[A-Z]/.exec(t)[1]}},t.installPlugin(e),a.installPlugin(e),i.installPlugin(e)};n(window)}()},{2:2,3:3,4:4}],2:[function(e,t,a){t.exports=function(){"use strict";return{installPlugin:function(e){e.EasyEdit.plugins.hidemd={init:function(){e.EasyEditEventManager.bind("EasyEditScreenLoad",this.initMdhide)},initMdhide:function(){var t,a,i,n;return"metadata"!==e.EasyEditCity.getCurrentScreenName()?void e.EasyEditCity.debug("This isn't the metadata tab, hidemd bailing"):(t=$('h3:contains("Widgets")'),t.add(t.nextUntil("h3").filter(":not(.ViperTP-bar)")).remove(),a=$('h3:contains("Global")'),a.each(function(e){var t=$(this);0!==e&&t.remove()}),i=$('h3:contains("Standard Content Page")'),i.each(function(e){var t=$(this);0!==e&&t.remove()}),n=$('h3:contains("Course Information")'),n.each(function(e){var t=$(this);0!==e&&t.remove()}),$('h4:contains("Asset")').next().remove(),void $('h4:contains("Asset")').remove())}}}}}()},{}],3:[function(e,t,a){t.exports=function(){"use strict";return{installPlugin:function(e){e.EasyEdit.plugins.metadataAssetFinder={pluginConfig:{allowedAssetTypes:"news_item, page_standard, image, pdf_file, calendar_event_single",assetTypeErrorMsg:"This asset type is not allowed",alreadyChosenErrorMsg:"You have already selected that asset, please choose a different one"},init:function(){var t=this;$.extend(t.pluginConfig,e.EasyEditConfig.pluginConfig.relatedAssets),e.EasyEditEventManager.bind("EasyEditScreenLoad",t.metadataAssetFinder)},metadataAssetFinder:function(){var t=e.EasyEdit.plugins.metadataAssetFinder;e.EasyEditAssetManager.getCurrentAsset(function(a){for(var i,n,d,s,r,l=t.pluginConfig.metadataFields.length,o=0,c=!1;l>o;o++)r=t.pluginConfig.metadataFields[o],i=$("#metadata_field_text_"+r.id+"_value"),0!==i.length&&(c=!0,n=$("#metadata_field_text_"+r.id+"_default"),n.removeAttr("checked"),n.val(""),r.showField||i.hide(),i.removeAttr("disabled"),n.closest(".sq-metadata-settings-wrapper").hide(),s=$("#asset_finder_meta_"+r.id),0===s.length&&i.before('<span id="asset_finder_meta_'+r.id+'" class="asset_finder_meta fieldNonEditable" title="Find Image"><span></span></span>'),i.siblings('div[id^="current_related_content_"]').length?e.EasyEditCity.debug("we have already initialised "+r.id):(i.after('<div class="related-content-picker" id="current_related_content_'+r.id+'"></div>'),d=$("#current_related_content_"+r.id),r.$fieldVal=i,r.$fieldRelated=d,r.relatedAssets=[],i.val()?d.html(""):(e.EasyEditCity.debug("no related content text to be updated"),d.html("No related content"))));c&&(t.buildRelatedAssetsList(),$(".asset_finder_meta").click(function(){var a=$(this).attr("id").replace("asset_finder_meta_",""),i=t.getFieldObject(a),n=i.$fieldVal;return e.EasyEditAssetFinder.init({rootNode:i.rootNode,focusAssetId:i.focusNode||null,bindElem:"#ees_assetFinderBody",includeDependants:!0,callback:function(a){if(-1!==t.pluginConfig.allowedAssetTypes.indexOf(a.attr.type_code)){if(e.EasyEditOverlay.showOverlay("success",{timeout:1e3,message:"Metadata field updated"}),""===n.val())n.val(a.id);else{if(e.EasyEditCity.debug(i.relatedAssets),-1!==$.inArray(a.id,i.relatedAssets))return void e.EasyEditOverlay.showOverlay("error",{timeout:2e3,message:t.pluginConfig.alreadyChosenErrorMsg});n.val(n.val()+","+a.id)}n.change(),"No related content"===i.$fieldRelated.text()&&i.$fieldRelated.text(""),i.$fieldRelated.append(t.insertRelatedDiv(a)),i.relatedAssets.push(a.id),1===i.relatedAssets.length&&t.makeListsSortable(i)}else e.EasyEditOverlay.showOverlay("error",{timeout:2e3,message:t.pluginConfig.assetTypeErrorMsg})}}),!1}))})},makeListsSortable:function(t){var a=e.EasyEdit.plugins.metadataAssetFinder;$(t.$fieldRelated).sortable({stop:function(){var e=a.getFieldObject(this.id.replace(/[^0-9]/g,""));e.$fieldVal.val(""),e.relatedAssets=[],e.$fieldRelated.children().each(function(t,a){e.relatedAssets.push(a.id),e.$fieldVal.val(function(e,t){return t+a.id+","})}),e.$fieldVal.val(function(e,t){return t.replace(/,$/,"")}),e.$fieldVal.change()},disabled:!1,axis:"y",forcePlaceholderSize:!1,opacity:.5,tolerance:"pointer",containment:"parent"})},buildRelatedAssetsList:function(){var t,a,i=e.EasyEdit.plugins.metadataAssetFinder,n=i.pluginConfig.metadataFields.length,d=0,s=[],r=new e.EasyEditAPI,l=null;for(e.EasyEditAssetManager.getCurrentAsset(function(e){l=e.id});n>d;d++)t=i.pluginConfig.metadataFields[d],e.EasyEditCity.debug("building list o' divs for "+t.id),t.$fieldVal&&0!==t.$fieldVal.length?(a=t.$fieldVal.val(),e.EasyEditCity.debug("val for "+t.id+" is "+a),""!==a?(s.push(t),-1===a.indexOf(",")?t.relatedAssets=[a]:t.relatedAssets=a.split(","),e.EasyEditCity.debug("related assets is calculated as: "+t.relatedAssets)):e.EasyEditCity.debug("no related assets")):e.EasyEditCity.debug(t.id+" was not found on the page, not setting up the list");e.EasyEditCity.debug(s),0!==s.length&&!function o(t){for(var a=t.shift(),n=a.relatedAssets.length,d=0;n>d;d++)r.queue("getGeneral",{asset_id:a.relatedAssets[d],get_attributes:0});r.run(function(){return function(n){var d,s=n.length,r=0;for(e.EasyEditCity.debug("api run came back for "+a.id+"("+a.relatedAssets.length+" related assets: "+a.relatedAssets+")"),e.EasyEditCity.debug(n);s>r;r++)d=n[r],0===a.$fieldRelated.find("#"+d.data.id).length&&l!=d.data.id&&(d.data.name||d.data.attr?(e.EasyEditCity.debug("appending div to "+a.$fieldRelated[0].id),a.$fieldRelated.append(i.insertRelatedDiv(d.data))):(e.EasyEditCity.debug("Unexpected data in Callback"),d.data.error?e.EasyEditCity.debug(d.data.error):e.EasyEditCity.debug(d.data)));i.makeListsSortable(a),t.length&&o(t)}}(),r.runMode.SYNC)}(s)},insertRelatedDiv:function(t){var a,i=this,n=$("<div>",{id:t.id,"class":"related_content"});return a=t.name||t.attr.name,$("<span>",{text:a+" (id: "+t.id+")"}).appendTo(n),$("<span>",{"class":"delete_related_content",click:function(){var t,a,n=$(this),d=n.parent(),s=d.attr("id"),r=d.parent(),l=r.attr("id");t=l.replace("current_related_content_",""),e.EasyEditCity.debug("deleting from field "+t),a=i.getFieldObject(t),a.$fieldVal.val(function(e,t){return t.replace(s,"").replace(",,",",").replace(/^,|,$/g,"")}),delete a.relatedAssets[s],d.fadeOut("slow",function(){d.remove()}),a.$fieldVal.change(),""===a.$fieldVal.attr("value")&&r.text("No related content")}}).appendTo(n),n},getFieldObject:function(t){for(var a=e.EasyEdit.plugins.metadataAssetFinder,i=a.pluginConfig.metadataFields,n=i.length,d=0;n>d;d++)if(i[d].id===parseInt(t,10))return i[d];return null}}}}}()},{}],4:[function(e,t,a){t.exports=function(){"use strict";return{installPlugin:function(e){!function(){var t={objectName:"widgetsDefault",className:"widgets",displayName:"Widgets",lockType:"metadata",isDefault:!1},a=function(e){var a={},i=!1;for(var n in e)e.hasOwnProperty(n)&&(a[n]=e[n],"Content"==n&&(a.Widgets=t,i=!0));return i||(a.Widgets=t),function(){return a}};$.each(["defaultAsset","page_standard","news_item","calendar_event_single","folder"],function(t,i){var n=e.EasyEditScreens.assetTypes[i].getConfig();e.EasyEditScreens.assetTypes[i].getConfig=a(n)})}(),e.EasyEditScreens.screen.widgetsDefault={cache:{asset:void 0},widgets:{20981:{name:"the empty widget"},19271:{name:"News widget",md_section:19505},19541:{name:"Events widget",md_section:19503},19341:{name:"Courses widget",md_section:19502},15313:{name:"Testimonials widget",md_section:19819},24497:{name:"Contact widget",md_section:18921},15347:{name:"Map widget",md_section:19739},15351:{name:"Free text widget",md_section:18952},18958:{name:"Free text widget B",md_section:18954},903:{name:"Flickr widget",md_section:12241},118385:{name:"Twitter widget",md_section:177524},101598:{name:"RSS widget",md_section:101626},177419:{name:"Profiles widget",md_section:177570},181764:{name:"Free HTML widget",md_section:181750},187627:{name:"Spotlight on Research widget",md_section:187795},274413:{name:"Navigation",md_section:274837},121480:{name:"Social",md_section:121258},332982:{name:"Open Days",md_section:333018}},plugin_config:{allowed_asset_types:"news_item, page_standard, image, pdf_file, folder",asset_type_error_msg:"This asset type is not allowed",widgets_onpage_md_field:20462,widgets_onpage_md_field_name:"widgets.onPage"},containerId:null,init:function(t,a,i){var n=this,d=-1!==document.location.hostname.indexOf("cass.city.ac.uk");d&&(n.widgets[107766]={name:"Call to action",md_section:107852}),n.containerId=t,e.EasyEditAssetManager.getCurrentAsset(function(t){t.acquireLock("all",function(t){"object"==typeof t[0]&&t[0].warning&&t[0].message.match(/^Unable to acquire "\w+" lock/)?i.call(n):n._getTemplate(function(t,a){var d=$(n.containerId);d.empty(),d.append(t),a&&(e.EasyEditScreens.screen.metadataDefault._attachEvents.call(n),n._attachWidgetEvents(),n._renderWidgets()),i.call(n)})})})},attachWysiwygEvents:function(){},_getTemplate:function(t){var a=this,i="";$("body").addClass("widgets"),e.EasyEditAssetManager.clearCurrentAssetCache(),e.EasyEditAssetManager._currentAssetId=null,e.EasyEditAssetManager.getCurrentAsset(function(e){a.cache.asset=e,e.getMetadata(function(e){e[a.plugin_config.widgets_onpage_md_field_name]?(i='<div id="ees_editMetadata"><h4 class="sectionHeading">Widgets</h4><a id="add-widget" class="greyButton loading" href="#"><span></span><span></span></a><div id="widgets" style="display: none;"><h4>Available Widgets<a href="#" class="closeAvailableWidgets">X</a></h4><ul id="available-widgets"><li class="no-more-widgets">No More Widgets to add</li></ul></div><div id="ees_editWidgets"></div><input type="hidden" id="widgets-on-page" name="metadata_field_text_20462_value" value=""/></div>',t.call(this,i,!0)):(i='<div id="ees_editMetadata"><h3>No schema Applied</h3><p>This asset does not have the widget metadata schema applied.Your administrator will need to apply the widget schema before youwill be able to enter any metadata values.</p></div>',t.call(this,i,!1))})})},_attachWidgetEvents:function(){var e=this;$("#add-widget").click(function(e){e.preventDefault(),$("#widgets").slideToggle()}),$("#ees_editWidgets").sortable({stop:e._changeWidgetOrder,axis:"y",forcePlaceholderSize:!0,containment:"parent",opacity:.5,tolerance:"pointer",handle:".widget-reorder-handle"})},_changeWidgetOrder:function(t,a){var i=[],n=$(t.target).children("div");n.length?n.each(function(e,t){var a=t.id.replace(/^[^0-9]+/,"");i.push(a)}):i.push("20981"),$("#widgets-on-page").val(i.join(",")),e.EasyEditComponentsToolbar.enableSaveButton()},_renderWidgets:function(){var t=this,a=t.cache.asset;$("body").append('<div id="widgets_metadata_container" style="display:none"></div>'),this._widgetsMetadataContainer=$("#widgets_metadata_container"),e.EasyEditScreens.screen.metadataDefault.init("#widgets_metadata_container",null,function(){$("#ees_screenContent").append($('input[type="hidden"][name^="metadata_field_related_asset_"]').detach()),$("#add-widget").removeClass("loading").find("span:first-child").text("Add Widget"),$.each(t.widgets,function(e,t){delete t.chosen});var i=a.metadataValues[t.plugin_config.widgets_onpage_md_field_name];""===i||"20981"===i?$("#widgets-on-page").val("20981"):($("#widgets-on-page").val(i),$.each(i.split(","),function(e,a){t._addWidget(a)})),t._updateWidgetPicker(),t._widgetsMetadataContainer.detach(),e.EasyEditScreens.screen.metadataDefault.containerId="#main_form"})},_addWidget:function(e){var t,a=this,i=a.widgets[e];a.cache.asset;i&&(i.chosen=!0,t=$("<div></div>",{id:i.name.replace(/\s/g,"-").toLowerCase()+"-"+e}),$("<span></span>",{"class":"widget-reorder-handle"}).appendTo(t),$("<span></span>",{"class":"widget-name",text:i.name}).appendTo(t),$("<span></span>",{"class":"remove-widget "+e,click:function(e){var t=$(this),i=t.attr("class");e.preventDefault(),a.widgets[i.substr(i.indexOf(" ")+1)].chosen=!1,t.parent().slideUp(function(){var e=$(this);a._widgetsMetadataContainer.append(e.find(".settings .editSection").detach()),e.remove(),a._changeWidgetOrder({target:$("#ees_editWidgets")}),a._updateWidgetPicker()})}}).appendTo(t),$("<span></span>",{"class":"edit-widget",text:"Settings",click:function(){$(this).next().toggle()}}).appendTo(t),t.appendTo("#ees_editWidgets"),a._appendWidgetSettings(e))},_updateWidgetPicker:function(){var e=this,t=$("#available-widgets");t.children().remove(),$.each(e.widgets,function(a,i){"20981"===a||i.chosen||$("<li></li>",{"class":a}).append($("<a></a>",{text:i.name,click:e._addWidgetFromPicker,href:"#"}).append($("<span></span>",{text:"+"}))).appendTo(t)}),0===t.children().length&&t.append("<li>No more widgets to add</li>")},_addWidgetFromPicker:function(t){var a=e.EasyEditScreens.screen.widgetsDefault,i=$(this),n=i.parent().attr("class");i.parent().remove(),t.preventDefault(),a._addWidget(n),a._changeWidgetOrder({target:$("#ees_editWidgets")}),a._updateWidgetPicker()},_appendWidgetSettings:function(t){var a,i=this,n=i.widgets[t],d="#"+n.name.replace(/\s/g,"-").toLowerCase()+"-"+t,s=$("<div></div>",{"class":"settings"}),r=!1;if(!n.md_section)return e.EasyEditCity.debug("no widget.md_section, appending widget.extra_info instead"),void s.append("<p><strong>"+n.extra_info+"</strong></p>");e.EasyEditCity.debug("appending settings for "+t);var l=this._widgetsMetadataContainer.find("#metadata_field_text_"+n.md_section+"_value").closest(".editSection");$(d).append(s),s.append(l.detach()),"18891"===t&&s.append(this._widgetsMetadataContainer.find("#metadata_field_text_18833_value").closest(".editSection").detach()),$(d).find('input[id$="default"]').each(function(e,t){var a=$(this);a.is(":checked")&&a[0].click(),a.next().hide(),a.hide()}).end().find("input").bind("keyup blur change",function(t){$(t.target).addClass("changed"),e.EasyEditComponentsToolbar.enableSaveButton()}),"2807"===t&&e.EasyEditScreens.screen.metadataDefault._attachEvents.call(i),"Profiles widget"!==n.name&&"Contact widget"!==n.name&&"Testimonials widget"!==n.name&&"Spotlight on Research widget"!==n.name||(r=!0,a=$(".row_2 input.inputText",s),a.attr("checked")||$(".row_3",s).addClass("picker-off"),a.click(function(e){var t=$(".row_3",s);t.hasClass("picker-off")?t.removeClass("picker-off"):t.addClass("picker-off")})),r&&e.EasyEdit.plugins.metadataAssetFinder.metadataAssetFinder(),"Call to action"===n.name&&s.find('input[name^="metadata_field_date"]').parent().addClass("dateTime")},save:function(t){e.EasyEditScreens.screen.metadataDefault.save(t)}}}}}()},{}]},{},[1]);